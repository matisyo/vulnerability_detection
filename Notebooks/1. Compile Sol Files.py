from utils.file_compiler import FileCompiler
from utils.splited_bytecode_parser import FileBytecodeParser
from utils.code_parser import FileCodeParser
import pandas as pd
import sys

sys.path.append('../')

CONTRACTS_PATH = '../contracts'
BYTECODES_PATH = '../data/bytecodes'

df = pd.read_csv('../data/vulnerabilities.csv')
df.head(3)

contratos = list(df.contrato.unique())
print(len(contratos))

def get_bytecode(cname,resultados,path):
    contract = f"{path}/{cname}.sol"
    fc = FileCompiler(contract,verbose=False)
    print(fc.solc_version)
    if fc.solc_version !='old_version':
        for tt in fc.bytecode:
            if len(fc.bytecode[tt]['bin-runtime']) != 0:
                print(len(fc.bytecode[tt]['bin-runtime']))
                resultados['file'].append(cname)
                resultados['contract'].append(tt)
                resultados['code'].append(fc.bytecode[tt]['bin-runtime'])


dataset = {
    'contract': [],
    'contract_name': [],
    'code': [],
    'clean_code': [],
    'split_code': []
}
resultados = {'file': [],
              'contract': [],
              'code': []
              }

no_compilados = []
cont = 0
pos = 0
for i, cname in enumerate(contratos):
    contract = f"{BYTECODES_PATH}/{cname}.sol"
    try:
        get_bytecode(cname, resultados, CONTRACTS_PATH)
        print(f"{i} {contract}", end='\r')

        if cont == 1000:
            fle = f'{BYTECODES_PATH}/bytecode_contratos_{pos}_{pos + cont}.csv'
            pos += cont
            cont = -1
            df = pd.DataFrame(resultados)
            dataset = df.merge(df.groupby('file').agg({'contract': 'count'}).reset_index(), on='file')
            dataset.columns = ['file', 'contract', 'code', 'size']
            dataset.to_csv(fle, index=False)

            resultados = {
                'file': [],
                'contract': [],
                'code': []
            }

        cont += 1
    except:
        no_compilados.append(cname)

if len(resultados['file']) != 0:
    print()
    print(f"Faltan {cont} contratos")
    df = pd.DataFrame(resultados)
    dataset = df.merge(df.groupby('file').agg({'contract': 'count'}).reset_index(), on='file')
    dataset.columns = ['file', 'contract', 'code', 'size']
    dataset.to_csv(f'{BYTECODES_PATH}/bytecode_contratos_final.csv', index=False)

print(len(no_compilados), len(resultados['file']))